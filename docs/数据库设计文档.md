# 数据库设计文档

股票分析系统数据库结构说明与表关系文档。

## 概述

| 项目 | 说明 |
|------|------|
| 数据库类型 | SQLite（异步） |
| ORM框架 | SQLModel（SQLAlchemy + Pydantic） |
| 连接方式 | `sqlite+aiosqlite:///./data/stock.db` |
| 数据文件 | `backend/data/stock.db` |

## 数据库关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    股票数据域                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    ┌───────────────────┐                                                            │
│    │      stocks       │                                                            │
│    │    (股票信息)      │                                                            │
│    ├───────────────────┤                                                            │
│    │ PK code           │◄─────────────────┬─────────────┬─────────────┐             │
│    │    name           │                  │             │             │             │
│    │    market         │                  │             │             │             │
│    │    industry       │                  │             │             │             │
│    │    area           │                  │             │             │             │
│    │    list_date      │                  │             │             │             │
│    │    is_active      │                  │             │             │             │
│    │    updated_at     │                  │             │             │             │
│    └───────────────────┘                  │             │             │             │
│              │                            │             │             │             │
│              │ 1:N                        │ 1:N         │ 1:N         │ 1:N         │
│              ▼                            ▼             ▼             ▼             │
│    ┌───────────────────┐    ┌───────────────────┐ ┌──────────────┐ ┌─────────────┐ │
│    │   daily_kline     │    │   weekly_kline    │ │monthly_kline │ │stock_indica-│ │
│    │    (日K线)        │    │    (周K线)        │ │  (月K线)     │ │    tors     │ │
│    ├───────────────────┤    ├───────────────────┤ ├──────────────┤ │ (技术指标)  │ │
│    │ PK id             │    │ PK id             │ │ PK id        │ ├─────────────┤ │
│    │ IX code        ───┼────┤ IX code        ───┼─┤ IX code   ───┼─┤ PK id       │ │
│    │ IX trade_date     │    │ IX trade_date     │ │ IX trade_date│ │ IX code     │ │
│    │    open           │    │    open           │ │    open      │ │ IX trade_dt │ │
│    │    high           │    │    high           │ │    high      │ │ indicator_  │ │
│    │    low            │    │    low            │ │    low       │ │    type     │ │
│    │    close          │    │    close          │ │    close     │ │ params(JSON)│ │
│    │    pre_close      │    │    volume         │ │    volume    │ │ values(JSON)│ │
│    │    change_pct     │    │    amount         │ │    amount    │ │ created_at  │ │
│    │    volume         │    └───────────────────┘ └──────────────┘ └─────────────┘ │
│    │    amount         │                                                            │
│    │    turnover       │                                                            │
│    └───────────────────┘                                                            │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    投资组合域                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    ┌───────────────────┐                                                            │
│    │    portfolios     │                                                            │
│    │   (投资组合)       │                                                            │
│    ├───────────────────┤                                                            │
│    │ PK id             │◄────────────────────────────┐                              │
│    │    name           │                             │                              │
│    │    description    │                             │                              │
│    │    initial_capital│                             │                              │
│    │    created_at     │                             │                              │
│    │    updated_at     │                             │                              │
│    └───────────────────┘                             │                              │
│              │                                       │                              │
│              │ 1:N                                   │ 1:N                          │
│              ▼                                       ▼                              │
│    ┌───────────────────┐                 ┌───────────────────┐                      │
│    │    positions      │                 │   transactions    │                      │
│    │    (持仓记录)      │                 │    (交易记录)      │                      │
│    ├───────────────────┤                 ├───────────────────┤                      │
│    │ PK id             │                 │ PK id             │                      │
│    │ FK portfolio_id ──┼─────────────────┤ FK portfolio_id ──┘                      │
│    │    code           │                 │    code           │                      │
│    │    name           │                 │    trade_type     │                      │
│    │    quantity       │                 │    quantity       │                      │
│    │    avg_cost       │                 │    price          │                      │
│    │    buy_date       │                 │    commission     │                      │
│    │    notes          │                 │    trade_date     │                      │
│    │    created_at     │                 │    created_at     │                      │
│    └───────────────────┘                 └───────────────────┘                      │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    回测结果域                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    ┌─────────────────────────────────────────┐                                      │
│    │           backtest_results              │                                      │
│    │             (回测结果)                   │                                      │
│    ├─────────────────────────────────────────┤                                      │
│    │ PK id                                   │                                      │
│    │    strategy_name        策略标识         │                                      │
│    │    strategy_display_name 策略显示名      │                                      │
│    │    params (JSON)        策略参数         │                                      │
│    │    stock_code           股票代码         │                                      │
│    │    stock_name           股票名称         │                                      │
│    │    start_date           开始日期         │                                      │
│    │    end_date             结束日期         │                                      │
│    │    initial_capital      初始资金         │                                      │
│    │    final_capital        最终资金         │                                      │
│    │    total_return         总收益率         │                                      │
│    │    annualized_return    年化收益率       │                                      │
│    │    max_drawdown         最大回撤         │                                      │
│    │    sharpe_ratio         夏普比率         │                                      │
│    │    win_rate             胜率             │                                      │
│    │    trade_count          交易次数         │                                      │
│    │    result_detail (JSON) 完整结果         │                                      │
│    │    created_at           创建时间         │                                      │
│    └─────────────────────────────────────────┘                                      │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

图例说明:
─────────
PK = Primary Key (主键)
FK = Foreign Key (外键)
IX = Index (索引)
1:N = 一对多关系
```

---

## 表结构详解

### 1. stocks - 股票基本信息表

存储A股所有股票的基本信息。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| code | VARCHAR | 10 | **PRIMARY KEY** | - | 股票代码（如 000001） |
| name | VARCHAR | 50 | NOT NULL | - | 股票名称（如 平安银行） |
| market | VARCHAR | 10 | NULLABLE | - | 市场标识：SH=上海，SZ=深圳 |
| industry | VARCHAR | 50 | NULLABLE | - | 所属行业 |
| area | VARCHAR | 50 | NULLABLE | - | 所在地区/省份 |
| list_date | DATE | - | NULLABLE | - | 上市日期 |
| is_active | BOOLEAN | - | NOT NULL | TRUE | 是否活跃（可交易） |
| updated_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 最后更新时间 |

**示例数据：**
```
code       | name     | market | industry | area | list_date  | is_active
-----------|----------|--------|----------|------|------------|----------
000001     | 平安银行  | SZ     | 银行     | 广东 | 1991-04-03 | true
600519     | 贵州茅台  | SH     | 白酒     | 贵州 | 2001-08-27 | true
```

---

### 2. daily_kline - 日K线数据表

存储每只股票的日线行情数据。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | **PRIMARY KEY** AUTO_INCREMENT | - | 自增主键 |
| code | VARCHAR | 10 | **INDEX** | - | 股票代码 |
| trade_date | DATE | - | **INDEX** | - | 交易日期 |
| open | FLOAT | - | NOT NULL | - | 开盘价（元） |
| high | FLOAT | - | NOT NULL | - | 最高价（元） |
| low | FLOAT | - | NOT NULL | - | 最低价（元） |
| close | FLOAT | - | NOT NULL | - | 收盘价（元） |
| pre_close | FLOAT | - | NULLABLE | - | 前收盘价（元） |
| change_pct | FLOAT | - | NULLABLE | - | 涨跌幅（%） |
| volume | BIGINT | - | NOT NULL | - | 成交量（股） |
| amount | FLOAT | - | NOT NULL | - | 成交额（元） |
| turnover | FLOAT | - | NULLABLE | - | 换手率（%） |

**示例数据：**
```
id | code   | trade_date | open  | high  | low   | close | pre_close | change_pct | volume    | amount       | turnover
---|--------|------------|-------|-------|-------|-------|-----------|------------|-----------|--------------|----------
1  | 000001 | 2024-01-19 | 10.50 | 10.80 | 10.45 | 10.75 | 10.52     | 2.19       | 85000000  | 905000000.00 | 0.44
2  | 000001 | 2024-01-18 | 10.40 | 10.55 | 10.35 | 10.52 | 10.38     | 1.35       | 72000000  | 752000000.00 | 0.37
```

---

### 3. weekly_kline - 周K线数据表

存储每只股票的周线行情数据。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | **PRIMARY KEY** AUTO_INCREMENT | - | 自增主键 |
| code | VARCHAR | 10 | **INDEX** | - | 股票代码 |
| trade_date | DATE | - | **INDEX** | - | 该周最后一个交易日 |
| open | FLOAT | - | NOT NULL | - | 周开盘价（元） |
| high | FLOAT | - | NOT NULL | - | 周最高价（元） |
| low | FLOAT | - | NOT NULL | - | 周最低价（元） |
| close | FLOAT | - | NOT NULL | - | 周收盘价（元） |
| volume | BIGINT | - | NOT NULL | - | 周成交量（股） |
| amount | FLOAT | - | NOT NULL | - | 周成交额（元） |

**示例数据：**
```
id | code   | trade_date | open  | high  | low   | close | volume     | amount
---|--------|------------|-------|-------|-------|-------|------------|---------------
1  | 000001 | 2024-01-19 | 10.20 | 10.95 | 10.10 | 10.75 | 420000000  | 4380000000.00
```

---

### 4. monthly_kline - 月K线数据表

存储每只股票的月线行情数据。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | **PRIMARY KEY** AUTO_INCREMENT | - | 自增主键 |
| code | VARCHAR | 10 | **INDEX** | - | 股票代码 |
| trade_date | DATE | - | **INDEX** | - | 该月最后一个交易日 |
| open | FLOAT | - | NOT NULL | - | 月开盘价（元） |
| high | FLOAT | - | NOT NULL | - | 月最高价（元） |
| low | FLOAT | - | NOT NULL | - | 月最低价（元） |
| close | FLOAT | - | NOT NULL | - | 月收盘价（元） |
| volume | BIGINT | - | NOT NULL | - | 月成交量（股） |
| amount | FLOAT | - | NOT NULL | - | 月成交额（元） |

**示例数据：**
```
id | code   | trade_date | open  | high  | low   | close | volume      | amount
---|--------|------------|-------|-------|-------|-------|-------------|----------------
1  | 000001 | 2024-01-31 | 10.05 | 11.20 | 9.85  | 10.75 | 1800000000  | 18900000000.00
```

---

### 5. stock_indicators - 技术指标缓存表

缓存计算过的技术指标，避免重复计算。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | **PRIMARY KEY** AUTO_INCREMENT | - | 自增主键 |
| code | VARCHAR | 10 | **INDEX** | - | 股票代码 |
| trade_date | DATE | - | **INDEX** | - | 交易日期 |
| indicator_type | VARCHAR | 20 | NOT NULL | - | 指标类型 |
| params | TEXT | - | NOT NULL | - | 参数配置（JSON格式） |
| values | TEXT | - | NOT NULL | - | 指标值（JSON格式） |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**indicator_type 可选值：**

| 类型 | 说明 | params 示例 |
|------|------|-------------|
| MA | 移动平均线 | `{"periods": [5, 10, 20, 60]}` |
| MACD | MACD指标 | `{"fast": 12, "slow": 26, "signal": 9}` |
| RSI | 相对强弱指数 | `{"period": 14}` |
| KDJ | 随机指标 | `{"k": 9, "d": 3, "j": 3}` |
| BOLL | 布林带 | `{"period": 20, "std": 2}` |

**示例数据：**
```
id | code   | trade_date | indicator_type | params                    | values
---|--------|------------|----------------|---------------------------|----------------------------------
1  | 000001 | 2024-01-19 | MA             | {"periods":[5,10,20,60]}  | {"ma5":10.65,"ma10":10.52,...}
2  | 000001 | 2024-01-19 | MACD           | {"fast":12,"slow":26,...} | {"dif":0.15,"dea":0.12,"macd":0.06}
```

---

### 6. portfolios - 投资组合表

存储用户创建的投资组合。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | **PRIMARY KEY** AUTO_INCREMENT | - | 自增主键 |
| name | VARCHAR | 100 | NOT NULL | - | 组合名称 |
| description | TEXT | - | NULLABLE | - | 组合描述 |
| initial_capital | FLOAT | - | NOT NULL | 1000000.0 | 初始资金（元） |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**示例数据：**
```
id | name       | description        | initial_capital | created_at          | updated_at
---|------------|--------------------|-----------------|--------------------|--------------------
1  | 价值投资组合 | 长期持有蓝筹股      | 1000000.00      | 2024-01-01 10:00:00 | 2024-01-19 15:30:00
2  | 成长股组合  | 科技成长股投资      | 500000.00       | 2024-01-15 09:00:00 | 2024-01-19 14:00:00
```

---

### 7. positions - 持仓记录表

存储投资组合的当前持仓。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | **PRIMARY KEY** AUTO_INCREMENT | - | 自增主键 |
| portfolio_id | INTEGER | - | **FOREIGN KEY** **INDEX** | - | 所属组合ID |
| code | VARCHAR | 10 | NOT NULL | - | 股票代码 |
| name | VARCHAR | 50 | NOT NULL | - | 股票名称 |
| quantity | INTEGER | - | NOT NULL | - | 持有数量（股） |
| avg_cost | FLOAT | - | NOT NULL | - | 平均成本（元/股） |
| buy_date | DATE | - | NULLABLE | - | 首次买入日期 |
| notes | TEXT | - | NULLABLE | - | 备注 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**外键约束：** `portfolio_id` → `portfolios.id`

**示例数据：**
```
id | portfolio_id | code   | name     | quantity | avg_cost | buy_date   | notes
---|--------------|--------|----------|----------|----------|------------|------------------
1  | 1            | 000001 | 平安银行  | 10000    | 10.25    | 2024-01-05 | 低位建仓
2  | 1            | 600519 | 贵州茅台  | 100      | 1680.50  | 2024-01-10 | 长期持有
```

---

### 8. transactions - 交易记录表

存储投资组合的历史交易记录。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | **PRIMARY KEY** AUTO_INCREMENT | - | 自增主键 |
| portfolio_id | INTEGER | - | **FOREIGN KEY** **INDEX** | - | 所属组合ID |
| code | VARCHAR | 10 | NOT NULL | - | 股票代码 |
| trade_type | VARCHAR | 10 | NOT NULL | - | 交易类型：BUY/SELL |
| quantity | INTEGER | - | NOT NULL | - | 交易数量（股） |
| price | FLOAT | - | NOT NULL | - | 交易价格（元/股） |
| commission | FLOAT | - | NOT NULL | 0.0 | 手续费（元） |
| trade_date | DATE | - | NOT NULL | - | 交易日期 |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**外键约束：** `portfolio_id` → `portfolios.id`

**trade_type 可选值：**
- `BUY` - 买入
- `SELL` - 卖出

**示例数据：**
```
id | portfolio_id | code   | trade_type | quantity | price  | commission | trade_date
---|--------------|--------|------------|----------|--------|------------|------------
1  | 1            | 000001 | BUY        | 5000     | 10.20  | 25.50      | 2024-01-05
2  | 1            | 000001 | BUY        | 5000     | 10.30  | 25.75      | 2024-01-08
3  | 1            | 600519 | BUY        | 100      | 1680.50| 84.03      | 2024-01-10
```

---

### 9. backtest_results - 回测结果表

存储策略回测的结果。

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | **PRIMARY KEY** AUTO_INCREMENT | - | 自增主键 |
| strategy_name | VARCHAR | 50 | NOT NULL | - | 策略标识符 |
| strategy_display_name | VARCHAR | 100 | NOT NULL | - | 策略显示名称 |
| params | TEXT | - | NOT NULL | - | 策略参数（JSON格式） |
| stock_code | VARCHAR | 10 | NOT NULL | - | 回测股票代码 |
| stock_name | VARCHAR | 50 | NOT NULL | - | 回测股票名称 |
| start_date | VARCHAR | 10 | NOT NULL | - | 回测开始日期 |
| end_date | VARCHAR | 10 | NOT NULL | - | 回测结束日期 |
| initial_capital | FLOAT | - | NOT NULL | - | 初始资金（元） |
| final_capital | FLOAT | - | NOT NULL | - | 最终资金（元） |
| total_return | FLOAT | - | NOT NULL | - | 总收益率（%） |
| annualized_return | FLOAT | - | NOT NULL | - | 年化收益率（%） |
| max_drawdown | FLOAT | - | NOT NULL | - | 最大回撤（%） |
| sharpe_ratio | FLOAT | - | NOT NULL | - | 夏普比率 |
| win_rate | FLOAT | - | NOT NULL | - | 胜率（%） |
| trade_count | INTEGER | - | NOT NULL | - | 交易次数 |
| result_detail | TEXT | - | NOT NULL | - | 完整结果（JSON格式） |
| created_at | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**strategy_name 可选值：**

| 策略ID | 显示名称 | 说明 |
|--------|----------|------|
| ma_cross | MA交叉策略 | 快速均线上穿慢速均线买入 |
| double_ma | 双均线趋势策略 | 长期均线上方才执行金叉买入 |
| macd | MACD策略 | MACD金叉买入，死叉卖出 |
| macd_hist | MACD柱状图策略 | 柱状图由负转正买入 |
| rsi | RSI超买超卖策略 | RSI超卖区向上突破买入 |
| kdj | KDJ金叉死叉策略 | KDJ低位金叉买入 |
| bollinger | 布林带均值回归策略 | 价格触及下轨买入 |

**示例数据：**
```
id | strategy_name | strategy_display_name | params                        | stock_code | stock_name
---|---------------|----------------------|-------------------------------|------------|------------
1  | ma_cross      | MA交叉策略            | {"fast":5,"slow":20}          | 000001     | 平安银行
2  | macd          | MACD策略             | {"fast":12,"slow":26,"sig":9} | 600519     | 贵州茅台

   | start_date | end_date   | initial_capital | final_capital | total_return | annualized_return
   |------------|------------|-----------------|---------------|--------------|------------------
   | 2023-01-01 | 2024-01-19 | 100000.00       | 115230.00     | 15.23        | 14.52
   | 2023-01-01 | 2024-01-19 | 100000.00       | 108560.00     | 8.56         | 8.15

   | max_drawdown | sharpe_ratio | win_rate | trade_count | created_at
   |--------------|--------------|----------|-------------|--------------------
   | -8.52        | 1.25         | 58.33    | 12          | 2024-01-19 16:00:00
   | -5.23        | 0.95         | 55.00    | 8           | 2024-01-19 16:05:00
```

**result_detail JSON 结构：**
```json
{
  "equity_curve": [
    {"date": "2023-01-03", "equity": 100000},
    {"date": "2023-01-04", "equity": 100250},
    ...
  ],
  "trades": [
    {
      "date": "2023-01-05",
      "type": "BUY",
      "price": 10.20,
      "quantity": 4900,
      "value": 49980
    },
    ...
  ],
  "metrics": {
    "sortino_ratio": 1.45,
    "calmar_ratio": 1.70,
    "profit_factor": 1.85,
    "avg_win": 3.25,
    "avg_loss": -1.75
  }
}
```

---

## 表关系说明

### 关系类型

| 关系 | 主表 | 从表 | 类型 | 说明 |
|------|------|------|------|------|
| 股票-日K线 | stocks | daily_kline | 1:N | 一只股票有多条日K线记录 |
| 股票-周K线 | stocks | weekly_kline | 1:N | 一只股票有多条周K线记录 |
| 股票-月K线 | stocks | monthly_kline | 1:N | 一只股票有多条月K线记录 |
| 股票-技术指标 | stocks | stock_indicators | 1:N | 一只股票有多条指标缓存 |
| 组合-持仓 | portfolios | positions | 1:N | 一个组合有多个持仓 |
| 组合-交易 | portfolios | transactions | 1:N | 一个组合有多条交易记录 |

### 外键约束

```sql
-- positions 表外键
ALTER TABLE positions
ADD CONSTRAINT fk_positions_portfolio
FOREIGN KEY (portfolio_id) REFERENCES portfolios(id);

-- transactions 表外键
ALTER TABLE transactions
ADD CONSTRAINT fk_transactions_portfolio
FOREIGN KEY (portfolio_id) REFERENCES portfolios(id);
```

### 逻辑关联（无物理外键）

以下表通过 `code` 字段逻辑关联，但没有物理外键约束：

- `stocks.code` ↔ `daily_kline.code`
- `stocks.code` ↔ `weekly_kline.code`
- `stocks.code` ↔ `monthly_kline.code`
- `stocks.code` ↔ `stock_indicators.code`
- `stocks.code` ↔ `positions.code`
- `stocks.code` ↔ `transactions.code`
- `stocks.code` ↔ `backtest_results.stock_code`

---

## 索引说明

### 现有索引

| 表名 | 索引字段 | 索引类型 | 用途 |
|------|----------|----------|------|
| stocks | code | PRIMARY KEY | 快速查找股票 |
| daily_kline | code | INDEX | 按股票查询K线 |
| daily_kline | trade_date | INDEX | 按日期查询K线 |
| weekly_kline | code | INDEX | 按股票查询周K线 |
| weekly_kline | trade_date | INDEX | 按日期查询周K线 |
| monthly_kline | code | INDEX | 按股票查询月K线 |
| monthly_kline | trade_date | INDEX | 按日期查询月K线 |
| stock_indicators | code | INDEX | 按股票查询指标 |
| stock_indicators | trade_date | INDEX | 按日期查询指标 |
| positions | portfolio_id | INDEX | 按组合查询持仓 |
| transactions | portfolio_id | INDEX | 按组合查询交易 |

### 建议添加的复合索引

```sql
-- 日K线：股票+日期复合索引，优化范围查询
CREATE INDEX idx_daily_kline_code_date ON daily_kline(code, trade_date);

-- 技术指标：股票+日期+类型复合索引
CREATE INDEX idx_indicators_code_date_type ON stock_indicators(code, trade_date, indicator_type);

-- 交易记录：组合+日期复合索引
CREATE INDEX idx_transactions_portfolio_date ON transactions(portfolio_id, trade_date);
```

---

## 数据类型映射

### SQLModel → SQLite 类型映射

| SQLModel 类型 | SQLite 类型 | Python 类型 | 说明 |
|---------------|-------------|-------------|------|
| Field(sa_column=Column(String(n))) | TEXT | str | 变长字符串 |
| Field(sa_column=Column(Integer)) | INTEGER | int | 整数 |
| Field(sa_column=Column(Float)) | REAL | float | 浮点数 |
| Field(sa_column=Column(Boolean)) | INTEGER | bool | 布尔值(0/1) |
| Field(sa_column=Column(Date)) | TEXT | date | 日期 |
| Field(sa_column=Column(DateTime)) | TEXT | datetime | 日期时间 |
| Field(sa_column=Column(Text)) | TEXT | str | 长文本 |

---

## 数据库初始化

### 自动初始化流程

1. 应用启动时检查 `data/` 目录是否存在
2. 若不存在则创建目录
3. 调用 `init_db()` 创建所有表

```python
# backend/app/database.py
async def init_db():
    async with async_engine.begin() as conn:
        await conn.run_sync(SQLModel.metadata.create_all)
```

### 手动重置数据库

```bash
# 1. 停止服务
# 2. 删除数据库文件
rm backend/data/stock.db

# 3. 重新启动服务，自动重建表结构
cd backend
uvicorn app.main:app --reload
```

---

## 数据量预估

| 表名 | 单条记录大小 | 预估记录数 | 预估空间 |
|------|-------------|-----------|----------|
| stocks | ~200B | 5,000 | ~1MB |
| daily_kline | ~100B | 5,000 × 250天 × 10年 = 12.5M | ~1.2GB |
| weekly_kline | ~80B | 5,000 × 52周 × 10年 = 2.6M | ~200MB |
| monthly_kline | ~80B | 5,000 × 12月 × 10年 = 600K | ~50MB |
| stock_indicators | ~500B | 5,000 × 250天 × 5指标 = 6.25M | ~3GB |
| portfolios | ~300B | 100 | ~30KB |
| positions | ~150B | 1,000 | ~150KB |
| transactions | ~120B | 10,000 | ~1.2MB |
| backtest_results | ~2KB | 1,000 | ~2MB |

**总计预估：** 约 4-5GB（10年全量数据）
